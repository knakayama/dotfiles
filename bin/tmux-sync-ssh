#!/usr/bin/env bash
# https://github.com/y-uuki/opstools

hosts=("$@")
session_name="tmux-ssh-$$"

while getopts ':t' args; do
  case "$args" in
    t)
      tty="$OPTARG"
      ;;
  esac
done

[ "$tty" =~ '^(config|kero)$' ] || { echo "unknown args: $tty" 1>&2; exit 1; }

tmux start-server

is_first="true"
for host in ${hosts[@]}; do
  if [[ "$tty" == "config" ]]; then
    cmd="ssh -t config 'ssh -o StrictHostKeyChecking=no root@$host'"
  else
    cmd="ssh -t kero 'sudo ssh -o StrictHostKeyChecking=no $host'"
  fi

  if [[ "$is_first" == "true" ]]; then
    tmux new-session -d -s "$session_name" "$cmd"

    is_first="false"
  else
    tmux split-window  -t "$session_name" "$cmd"
    tmux select-layout -t "$session_name" tiled >/dev/null
  fi
done

tmux set-window-option -t "$session_name" synchronize-panes on
tmux select-pane -t 0
tmux attach-session -t "$session_name"

# Local Variables:
# mode: Shell-Script
# sh-indentation: 2
# indent-tabs-mode: nil
# sh-basic-offset: 2
# End:
# vim: ft=sh sw=2 ts=2 et
